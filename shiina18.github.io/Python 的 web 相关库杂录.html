<h2>原文：<a href="https://shiina18.github.io/tech/2022/09/04/python-web">Python 的 web 相关库杂录</a></h2>
<hr/>
<h2>title: "Python 的 web 相关库杂录"
categories: Tech
updated: 2023-12-25
comments: true
mathjax: false</h2>
<p>随手找的一些模型部署简单例子.</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/460235764">Flask+Gunicorn+Service Streamer</a></li>
<li><a href="https://blog.csdn.net/nuohuang3371/article/details/113061659">Flask+Gunicorn</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/143678340">Flask+gevent</a></li>
<li><a href="https://mp.weixin.qq.com/s/Axkti1PXDh6o2bx6MMvnKQ">Tornado</a></li>
</ul>
<p>&lt;!-- more --&gt;</p>
<h2>uWSGI</h2>
<blockquote>
<p>uWSGI, pronounced "mu wiz gee" (u or $\mu$ whiskey), is a Web Server Gateway Interface (WSGI) server implementation that is typically used to run Python web applications.</p>
</blockquote>
<p>可以参考 <a href="https://www.fullstackpython.com/uwsgi.html">uWSGI - Full Stack Python</a> 收集的资源. Full Stack Python 是很好的资源站.</p>
<h2>Gunicorn</h2>
<blockquote>
<p>Green Unicorn, commonly shortened to "Gunicorn", is a Web Server Gateway Interface (WSGI) server implementation that is commonly used to run Python web applications.</p>
</blockquote>
<ul>
<li><a href="https://www.fullstackpython.com/green-unicorn-gunicorn.html">Green Unicorn (Gunicorn) - Full Stack Python</a></li>
</ul>
<blockquote>
<p>Use Gunicorn, unless you are deploying on Windows, in which case use mod_wsgi.</p>
</blockquote>
<p>uWSGI 很多功能与 Nginx 等部件重复, 文档也很杂乱 (开发者承认很难写). Gunicorn 简单效果好.</p>
<ul>
<li>Antonis Christofides. (2020). <a href="https://medium.com/django-deployment/which-wsgi-server-should-i-use-a70548da6a83">Which WSGI server should I use?</a></li>
</ul>
<h2>gevent</h2>
<blockquote>
<p>gevent is a coroutine-based Python networking library that uses greenlet to provide a high-level synchronous API on top of the libev or libuv event loop.</p>
</blockquote>
<ul>
<li><a href="http://www.gevent.org/intro.html">gevent introduction</a></li>
<li><a href="https://sdiehl.github.io/gevent-tutorial/">gevent For the Working Python Developer</a></li>
</ul>
<blockquote>
<p>A monkey patch (also spelled monkey-patch, MonkeyPatch) is a way to extend or modify the runtime code of dynamic languages (e.g. Smalltalk, JavaScript, Objective-C, Ruby, Perl, Python, Groovy, etc.) without altering the original source code.</p>
</blockquote>
<ul>
<li>罗辑. (2018). <a href="https://www.zhihu.com/question/26671162/answer/38614017">有哪些应用场景适合用 python 的 gevent 来完成?</a></li>
<li>罗辑. (2018). <a href="https://www.zhihu.com/question/29995881/answer/83152937">Python 黑魔法: greenlet</a></li>
</ul>
<h2>Ngnix</h2>
<blockquote>
<p>Nginx, pronounced "engine-X", is the second most common web server among the top 100,000 websites. Nginx also functions well as a reverse proxy to handle requests and pass back responses for Python WSGI servers or even other web servers such as Apache.</p>
</blockquote>
<ul>
<li><a href="https://www.fullstackpython.com/nginx.html">Nginx - Full Stack Python</a></li>
</ul>
<h2>Flask</h2>
<blockquote>
<p>Flask is a Python web framework built with a small core and easy-to-extend philosophy.</p>
</blockquote>
<p>基本用法没什么好说的. 此外有个自动生成 Swagger UI 的包 <a href="https://flask-restx.readthedocs.io/en/latest/">Flask-RESTX</a>. Flask-RESTX is a community driven fork of Flask-RESTPlus (后者很久没维护了, 前者也有一段时间不怎么维护了).</p>
<p>部署到生产时官方 <a href="https://flask.palletsprojects.com/en/2.2.x/tutorial/deploy/#run-with-a-production-server">tutorial</a> 用了 <a href="https://docs.pylonsproject.org/projects/waitress/en/stable/">Waitress</a>; <a href="https://flask.palletsprojects.com/en/2.2.x/deploying/">这里</a> 介绍了各种常见 WSGI server 部署 Flask 的例子.,</p>
<ul>
<li><a href="https://www.zhihu.com/question/27316652/answer/299186589">一个并发的网站, Tornado 与 Flask 应该选哪一个?</a></li>
<li><a href="https://www.fullstackpython.com/flask.html">Flask - Full Stack Python</a></li>
<li><a href="https://stackoverflow.com/questions/19261833/what-is-an-endpoint-in-flask">python - What is an 'endpoint' in Flask? - Stack Overflow</a></li>
</ul>
<h2>FastAPI</h2>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/672806587">Flask 已死, FastAPI 是未来</a></li>
</ul>
<h2>Celery</h2>
<blockquote>
<p><a href="https://www.fullstackpython.com/celery.html">Celery</a> is a task queue implementation for Python web applications used to asynchronously execute work outside the HTTP request-response cycle.</p>
</blockquote>
<p>异步基本就用这个库. Celery 命名 <a href="https://github.com/celery/celery/issues/6048">来源</a> 于, 它把数据喂给 RabbitMQ.</p>
<p>把应用迁移到使用 Celery 不用改什么代码, 工作量主要在配置上.</p>
<p>&lt;details&gt;&lt;summary&gt;&lt;b&gt;一些资源&lt;/b&gt;&lt;font color="deepskyblue"&gt; (Show more &amp;raquo;)&lt;/font&gt;&lt;/summary&gt;
&lt;p&gt;&lt;a href="https://www.fullstackpython.com/celery.html"&gt;Full Stack Python&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://simpleisbetterthancomplex.com/tutorial/2017/08/20/how-to-use-celery-with-django.html"&gt;How to Use Celery and RabbitMQ with Django&lt;/a&gt; is a great tutorial that shows how to both install and set up a basic task with Django.&lt;/li&gt;
&lt;li&gt;&lt;a href="https://denibertovic.com/posts/celery-best-practices/"&gt;Celery - Best Practices&lt;/a&gt; explains things you should not do with Celery and shows some underused features for making task queues easier to work with.&lt;/li&gt;
&lt;li&gt;&lt;a href="https://blog.balthazar-rouberol.com/celery-best-practices"&gt;Celery Best Practices&lt;/a&gt; is a different author's follow up to the above best practices post that builds upon some of his own learnings from 3+ years using Celery.&lt;/li&gt;
&lt;li&gt;备用: &lt;a href="https://zhuanlan.zhihu.com/p/351328752"&gt;Python 分布式调度框架 Celery 踩坑日记&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;其他看到的&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://stackoverflow.com/questions/9077687/why-use-celery-instead-of-rabbitmq"&gt;python - Why use Celery instead of RabbitMQ? - Stack Overflow&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://blog.wolt.com/engineering/2021/09/15/5-tips-for-writing-production-ready-celery-tasks/"&gt;5 tips for writing production-ready Celery tasks - Wolt Blog&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://progressstory.com/tech/python/production-ready-celery-configuration/"&gt;Production-ready Celery configuration - Progress Story&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;进一步解释 Celery 机制&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://www.ines-panker.com/2020/10/28/celery-explained.html"&gt;Celery: A Few Gotchas Explained&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.distributedpython.com/2018/10/26/celery-execution-pool/"&gt;Celery Execution Pools: What is it all about? | distributedpython&lt;/a&gt; 这是专门写 Celery 的博客&lt;/li&gt;
&lt;/ul&gt;&lt;/details&gt;</p>
<p>除了一开始的 tutorial, 官方 userguide 建议先看 <a href="https://docs.celeryq.dev/en/stable/userguide/tasks.html">tasks</a>.</p>
<p>Celery 启动后先注册任务, 可以用 <code>--loglevel=DEBUG</code>, 搜索 tasks, 看任务有没有注册, 注册了哪些 (<code>autodiscover_tasks</code> 中可以指定搜索路径). 在代码中实际使用时, 函数路径必须和注册的任务名相同 (x.y.z, 注意相对 import).</p>
<h2>其他</h2>
<h3>Flask-RESTX demo</h3>
<p>需要注意的是, 如果开了 <code>.expect(validate=True)</code>, 发送不合法的请求后, Swagger UI 上不会有任何提示. 这是 Swagger UI 的一个 "bug", 见这个 <a href="https://github.com/python-restx/flask-restx/issues/472">issue</a>.</p>
<pre><code class="language-python">import flask
import flask_restx
from flask import request
from flask_restx import fields

app = flask.Flask(__name__)
api = flask_restx.Api(app=app, title='app title', version='2.3.3', description='app desc')

CONFERENCES_DESC = """
Conference operations

Markdown is supported.
"""
ns_conf = api.namespace(name='conferences', description=CONFERENCES_DESC)
model_conf_input = ns_conf.model(
    name='my_model',
    model={
        'name': fields.String(
            example='C7', description='name whatever', title='field title',
            min_length=1, max_length=10, pattern=r'[A-Z][0-9]', required=True
        ),
        # the default example is the first element of the enum argument ('A' in this case)
        'type': fields.String(enum=['A', 'B', 'C']),
        'nums': fields.List(
            fields.Integer(min=0, max=100),
            min_items=0, max_items=10, description='list of integers'
        ),
        'bool': fields.Boolean(),
    },
    strict=True
)
model_conf_response = ns_conf.model(name='response', model={
    'name': fields.String(description='haha'),
    'nums': fields.List(fields.Integer())
})


@ns_conf.route("/")
class ConferenceList(flask_restx.Resource):
    # `.doc(body=...)` or `.expect(...)` for input
    # `.doc(model=...)` for response
    @ns_conf.expect(model_conf_input, validate=True)
    @ns_conf.param('payload', 'some description goes here', _in='body')
    @ns_conf.response(200, 'Success', model_conf_response)
    @ns_conf.response(400, 'Validation Error')
    def post(self):
        """
        random example

        **markdown is also supported in docstring**
        """
        name = request.json.get('name')
        nums = request.json.get('nums')
        return {
            'name': name,
            'nums': nums
        }


@ns_conf.route("/&lt;int:id&gt;")
class Conference(flask_restx.Resource):
    @ns_conf.doc(params={'id': 'An ID'})
    def get(self, id):
        return id


if __name__ == '__main__':
    app.run(debug=True)
</code></pre>
<h3>Memo</h3>
<ul>
<li>Exadel AI Team. (2020). <a href="https://exadel.com/news/deploying-multiple-machine-learning-models-on-a-single-server/">Deploying Multiple Machine Learning Models on a Single Server</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/475826716">模型压测: Locust</a> (很简单)</li>
<li>测试工具 wrk</li>
</ul>
