<h2><a href="https://github.com/Young-Lord/Young-Lord.github.io/blob/master/_posts/2025-07-20-基于RawDisk，将双系统挂载为虚拟机.md">仓库源文</a>，<a href="https://young-lord.github.io/posts/rawdisk-vm">站点原文</a></h2>
<p>不知不觉就高考完一个多月了啊。</p>
<p>最近在配置新电脑，打算和往常一样用Arch Linux，但又担心有的商业软件只有Windows能用。刚好之前网上冲浪的时候看到Kiri的<a href="https://kirikira.moe/post/32/">一篇教程</a>，硬件配置又足够，于是就去折腾了。</p>
<p>总之，这篇教程的目的是：在Arch Linux上，使用VirtualBox，把同一硬盘上的Windows系统作为虚拟机启动。</p>
<p>据说使用KVM的话，还可以做到直接映射整个硬盘，从而得到更好的性能，但我现在暂时没有这个需求。感兴趣的可以搜索<code>kvm disk pass-through</code>。</p>
<p>先大概讲下最终效果：剪贴板共享正常，剪贴板文件共享仅Linux到Windows正常，拖放传输文件不正常，声音延迟1秒左右。</p>
<h2>准备</h2>
<p>首先先装一堆包：<code>sudo pacman -S pipewire pipewire-pulse virtualbox virtualbox-guest-iso</code></p>
<h3>创建RawDisk</h3>
<p>（官方文档并没有出现RawDisk的规范写法，你写成rawdisk一类的也没问题）</p>
<p>注意，继续阅读本文前请先浏览<a href="https://www.virtualbox.org/manual/ch09.html#rawdisk">官方文档</a>！过时的命令可能导致问题！本文最后更新时间为2025年7月20日。</p>
<p>以下内容基本只用于记录与补充，如果不明白可以去看开头提到的<a href="https://kirikira.moe/post/32/">那篇教程</a>。</p>
<p>首先看看你的分区结构（不重要的信息略去）（<code>sd{x}</code>与<code>nvme{x}</code>类似）：</p>
<pre><code class="lang-console">niko-mech-arch% sudo fdisk -l
Disk /dev/nvme0n1: 953.87 GiB, 1024209543168 bytes, 2000409264 sectors
Disklabel type: gpt

Device              Start        End    Sectors   Size Type
/dev/nvme0n1p1       2048    1050623    1048576   512M EFI System
/dev/nvme0n1p2    1050624 1511000063 1509949440   720G Linux filesystem
/dev/nvme0n1p4 1578108928 1578141695      32768    16M Microsoft reserved
/dev/nvme0n1p5 1578141696 1998243839  420102144 200.3G Microsoft basic data
/dev/nvme0n1p7 1998858240 2000406527    1548288   756M Windows recovery environment
</code></pre>
<p>我在<code>nvme0n1p1</code>这个分区已经安装了<code>systemd-boot</code>，可以正常识别Windows。</p>
<p>接下来把这两个分区做成RawDisk:</p>
<pre><code class="lang-console">// 临时给用户 niko 赋予直接访问磁盘权限，用于创建RawDisk
$ sudo setfacl -m u:niko:rw /dev/nvme0n1{,p1,p5}
// 生成 RawDisk
$ VBoxManage createmedium disk --filename win11-rawdisk-rootless.vmdk --format=VMDK --variant RawDisk --property RawDrive=/dev/nvme0n1 --property Partitions=1，5 --property Relative=1
// 将临时授予的权限取消
$ sudo setfacl -b /dev/nvme0n1{,p1,p5}
</code></pre>
<p>顺带一提，如果要移除已经创建的RawDisk，可以使用<code>VBoxManage closemedium disk win11-rawdisk-rootless.vmdk --delete</code>。</p>
<p>这里我遇到了如下问题：</p>
<pre><code class="lang-console">niko-mech-arch% VBoxManage createmedium disk --filename win11-rawdisk-rootless.vmdk --format=VMDK --variant RawDisk --property RawDrive=/dev/nvme0n1 --property Partitions=1,5 --property Relative=1

0%...VBOX_E_FILE_ERROR
VBoxManage: error: Failed to create medium
VBoxManage: error: Could not create the medium storage unit '/home/niko/win11-rawdisk-rootless.vmdk'.
VBoxManage: error: VMDK: Image path: '/home/niko/win11-rawdisk-rootless.vmdk'. Failed to open the raw drive '/dev/nvme0n1' for reading (VERR_ACCESS_DENIED) (VERR_ACCESS_DENIED).
VBoxManage: error: VMDK: could not create raw descriptor for '/home/niko/win11-rawdisk-rootless.vmdk' (VERR_ACCESS_DENIED)
VBoxManage: error: Details: code VBOX_E_FILE_ERROR (0x80bb0004), component MediumWrap, interface IMedium
VBoxManage: error: Context: "RTEXITCODE handleCreateMedium(HandlerArg*)" at line 630 of file VBoxManageDisk.cpp
</code></pre>
<p>怀疑是因为ESP已经被挂载到了<code>/boot</code>，于是<code>umount</code>后重试，报错内容相似。于是换了下文的方法。</p>
<p>找个空闲空间创建一个新的ESP（300MB就够），进入Windows，为这个分区指定一个盘符（比如<code>H:</code>），进入cmd执行<code>bcdboot C:\Windows /s H:</code>，随后可以移除盘符。以下假设该分区在Linux中表示为<code>nvme0n1p6</code>。</p>
<p>修改上面的命令重新运行。成功后，得到<code>win11-rawdisk-rootless-pt.vmdk</code>与<code>win11-rawdisk-rootless.vmdk</code>两个文件。</p>
<h3>挂载磁盘</h3>
<p>以普通用户身份打开VirtualBox，创建一个Windows 11虚拟机，不分配硬盘。创建完成后，进入设置，执行以下更改：</p>
<ul>
<li>General -&gt; Extended Features 中，启用EFI，禁用Secure Boot</li>
<li>Storage -&gt; Devices 中，添加上一步创建的RawDisk</li>
<li>Audio -&gt; Host Audio Driver 由<code>Default</code>改为<code>PulseAudio</code></li>
</ul>
<h3>启动虚拟机</h3>
<p>可能会提示“未激活”，原因可能是Windows检测到的硬件改变了，可以用某个工具一次性永久激活。</p>
<h3>一些优化</h3>
<p>安装Guest Additions就不用我说了吧。</p>
<p>为了获取USB设备列表，VirtualBox提示要用这条命令把用户加入对应组：<code>sudo groupmems -g vboxusers -a niko</code></p>
<p>使用<code>setfacl -m</code>临时授予的权限会在重启后失效，我让DeepSeek老师给了个解决方案：</p>
<pre><code class="lang-console">$ cat &lt;&lt; EOF | sudo tee /etc/udev/rules.d/99-persistent-acl-for-virtualbox-windows.rules
ACTION=="add", KERNEL=="nvme0n1p5", SUBSYSTEM=="block", RUN+="/bin/sh -c '/usr/bin/setfacl -m u:niko:rw /dev/nvme0n1p5'"
ACTION=="add", KERNEL=="nvme0n1p6", SUBSYSTEM=="block", RUN+="/bin/sh -c '/usr/bin/setfacl -m u:niko:rw /dev/nvme0n1p6'"
EOF
$ sudo udevadm control --reload-rules
// 下两行用于立即触发规则
$ sudo udevadm trigger --action=add --sysname-match=nvme0n1p5
$ sudo udevadm trigger --action=add --sysname-match=nvme0n1p6
</code></pre>
<p>某次更新后，VirtualBox内的Windows虚拟机会在进入桌面前Abort，关闭3D加速可以暂时解决。</p>
<h2>另外的话</h2>
<p>上海交通大学招生组的话一个字都别信。</p>
<div class="license">
  <p>本文遵守 <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA-4.0</a> 许可协议。<a href="https://github.com/Young-Lord/Young-Lord.github.io/blob/master/README.md#%E5%A3%B0%E6%98%8E">（不允许转载至简书或 CSDN）</a>
    <a rel="license" aria-label="详细了解协议内容" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
<!--        <img alt="CC BY-NC-SA-4.0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />-->
    </a>
  </p>
</div>