<h2>[ä»“åº“æºæ–‡](https://github.com/objcoding/objcoding.github.io/blob/master/_posts/2018-08-23- docker swarm load balancing.md)ï¼Œ<a href="https://objcoding.com/2018/08/23/-docker-swarm-load-balancing">ç«™ç‚¹åŸæ–‡</a></h2>
<hr/>
<h2>layout: post
title: "éªŒè¯Docker Swarmé›†ç¾¤çš„è´Ÿè½½å‡è¡¡"
categories: Docker
tags: swarm loadbalance overlay
author: å¼ ä¹˜è¾‰</h2>
<ul>
<li>content
{:toc}
swarm é›†ç¾¤çš„å†…éƒ¨ä¼šä¸ºå®¹å™¨çš„å„ä¸ªèŠ‚ç‚¹ä¹‹é—´è´Ÿè´£è´Ÿè½½å‡è¡¡çš„ç®¡ç†ï¼Œç°åœ¨æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ swarm çš„è´Ÿè½½å‡è¡¡ç‰¹æ€§ã€‚</li>
</ul>
<h2>åˆ›å»ºæµ‹è¯•é¡¹ç›®</h2>
<ul>
<li>ç¼–å†™æµ‹è¯•ç¨‹åºï¼š</li>
</ul>
<pre><code class="language-go">func main() {
  resp, _ := http.Get("http://myexternalip.com/raw")
  defer resp.Body.Close()
  content, _ := ioutil.ReadAll(resp.Body)
  r := gin.Default()
  r.GET("/addr", func(c *gin.Context) {
    c.JSON(200, gin.H{
      "addr": string(content),
    })
  })
  r.Run(":8081")
}
</code></pre>
<ul>
<li>ç¼–å†™ Dockerfileï¼š</li>
</ul>
<pre><code class="language-dockerfile">FROM golang:latest

WORKDIR $GOPATH/src/go-gin-demo

COPY . $GOPATH/src/go-gin-demo

RUN go get github.com/gin-gonic/gin &amp;&amp; go build .

EXPOSE 8081

ENTRYPOINT ["./go-gin-demo"]

</code></pre>
<ul>
<li>æ‰“åŒ…é•œåƒå¹¶ä¸Šä¼ åˆ° docker hubï¼š</li>
</ul>
<pre><code class="language-bash">$ docker build -t chenghuizhang/go-gin-demo:v3 .
$ docker push chenghuizhang/go-gin-demo:v3
</code></pre>
<h2>åˆ›å»ºé›†ç¾¤</h2>
<p>é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªç®¡ç†èŠ‚ç‚¹ï¼š</p>
<pre><code class="language-bash">$ docker swarm init --advertise-addr 193.xxx.61.178
</code></pre>
<p>è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œç”±äºæˆ‘çš„ä¸¤å°æœåŠ¡å™¨éƒ½åŒäºä¸€ä¸ªå†…ç½‘ç¯å¢ƒï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æŒ‡å®šå¤–ç½‘ ipï¼Œå¾—åˆ°ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre><code class="language-bash">$ docker swarm join --token xxxxxxxxxxxxxxxx 193.xxx.61.178:2377
</code></pre>
<p>å¦ä¸€å°æœåŠ¡å™¨åŠ å…¥ï¼Œç°åœ¨å¾—åˆ°äº†æ‹¥æœ‰ä¸¤ä¸ªèŠ‚ç‚¹çš„ swarm é›†ç¾¤ï¼š</p>
<p><img alt="docker swarm" src="https://raw.githubusercontent.com/objcoding/md-picture/master/img/swarm9.png"/></p>
<p><strong>è¿™é‡Œç‰¹åˆ«æ³¨æ„ä¸€ä¸‹ï¼Œç”±äºæ˜¯åŠ å…¥ç®¡ç†èŠ‚ç‚¹éœ€è¦é€šè¿‡å¤–ç½‘ï¼Œæ‰€ä»¥<code>docker swarm join</code>åŠ ä¸ªåœ°å€å‚æ•°ï¼š</strong></p>
<pre><code class="language-bash">$ docker swarm join --token xxxxxxxxxxxxxxxx 193.xxx.61.178:2377 --advertise-addr 111.xxx.254.127
</code></pre>
<h2>éƒ¨ç½²æµ‹è¯•</h2>
<ul>
<li>åˆ›å»ºé›†ç¾¤ç½‘ç»œé©±åŠ¨ï¼š</li>
</ul>
<pre><code class="language-bash">$ docker network create -d overlay mynet
</code></pre>
<ul>
<li>éƒ¨ç½² go-gin-demo åˆ°å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦å¤–ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦å¯é€šè¿‡ docker çš„ overlay è·¨ä¸»æœºç½‘è·¯é©±åŠ¨è®¿é—®ï¼š</li>
</ul>
<pre><code class="language-bash">$ docker service create -p 8081:8081 --network mynet --replicas 1 --name go-gin-demo chenghuizhang/go-gin-demo:v3
</code></pre>
<p>æŸ¥çœ‹æœåŠ¡ï¼š</p>
<pre><code>$ docker service ps go-gin-demo 
</code></pre>
<p>å‘ç° go-gin-demo éƒ¨ç½²åˆ°å·¥ä½œèŠ‚ç‚¹äº†ï¼Œè¿™æ—¶æˆ‘ä»¬é€šè¿‡ç®¡ç†èŠ‚ç‚¹ ip è®¿é—®ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img alt="docker swarm" src="https://raw.githubusercontent.com/objcoding/md-picture/master/img/swarm10.png"/></p>
<p>è¯´æ˜å³ä½¿ç®¡ç†èŠ‚ç‚¹æ²¡æœ‰éƒ¨ç½²è¯¥æœåŠ¡ï¼Œä»ç„¶æ˜¯å¯ä»¥é€šè¿‡ overlay è·¨ä¸»æœºç½‘ç»œè¿›è¡Œè°ƒç”¨çš„ã€‚</p>
<p>åŒæ—¶æˆ‘ä»¬æŸ¥çœ‹ç®¡ç†èŠ‚ç‚¹çš„ 8081 æ˜¯å¦æœ‰è¢«ç›‘å¬ï¼š</p>
<pre><code class="language-bash">$ lsof -i:8081
</code></pre>
<p><img alt="docker swarm" src="https://raw.githubusercontent.com/objcoding/md-picture/master/img/d_network8.png"/></p>
<p>å‘ç° go-gin-demo è™½ç„¶æ²¡æœ‰éƒ¨ç½²åˆ°ç®¡ç†èŠ‚ç‚¹ä¸Šï¼Œä½†å…¶ç«¯å£åœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šé¢ä¾ç„¶è¢«ç›‘å¬ç€ï¼Œ<strong>æ‰€ä»¥æˆ‘ä»¬å¾—å‡ºï¼Œæ•´ä¸ª overlay ç½‘ç»œä¸­ï¼Œæ¯ä¸ªæœåŠ¡éƒ½å¯ä»¥é€šè¿‡ä»»æ„ä¸€å°é›†ç¾¤å†…æœåŠ¡å™¨è®¿é—®ã€‚</strong></p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼ŒæœåŠ¡å™¨é˜²ç«å¢™éœ€è¦å¼€é€š docker ç›¸å…³çš„ç«¯å£ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œå°±æŠŠæœåŠ¡å™¨çš„é˜²ç«å¢™å…³é—­äº†ï¼š</p>
<pre><code class="language-bash">$ systemctl stop firewalld.service # centos 7 å…³é—­é˜²ç«å¢™
</code></pre>
<ul>
<li>éƒ¨ç½² go-gin-demo åˆ°ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè®¿é—®å…¶ä¸­ä¸€å°æœåŠ¡å™¨ï¼ŒéªŒè¯ swarm é›†ç¾¤æ˜¯å¦å…·å¤‡è´Ÿè½½å‡è¡¡ï¼š</li>
</ul>
<pre><code class="language-bash">$ docker service scale go-gin-demo=2
</code></pre>
<p><img alt="docker swarm" src="https://raw.githubusercontent.com/objcoding/md-picture/master/img/d_network7.png"/></p>
<p>è¿™æ—¶æˆ‘ä»¬éšæ„è®¿é—®ä¸€å°æœåŠ¡å™¨ï¼Œå¤šè®¿é—®å‡ æ¬¡ï¼Œä¼šå‡ºç°è¿”å›æ¥çš„æ˜¯å¦ä¸€å°æœåŠ¡å™¨çš„åœ°å€ï¼Œè¯´æ˜ swarm é›†ç¾¤å…·å¤‡è´Ÿè½½å‡è¡¡çš„ç‰¹æ€§ã€‚</p>
