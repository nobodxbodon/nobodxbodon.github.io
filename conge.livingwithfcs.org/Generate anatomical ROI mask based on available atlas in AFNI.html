<h2><a href="https://github.com/conge/conge.github.io/blob/master/_posts/2011/2011-01-16-generate-anatomical-roi-mask-based-on.html">仓库源文</a>，<a href="https://conge.livingwithfcs.org/2011/01/16/generate-anatomical-roi-mask-based-on.html">站点原文</a></h2>
<hr/>
<p>layout: post
title: Generate anatomical ROI mask based on available atlas in AFNI
date: '2011-01-16T05:50:00.004-09:00'
author: Qingyang
tags:</p>
<ul>
<li>读书笔记</li>
<li>心理新知
modified_time: '2011-01-18T13:03:21.568-09:00'
blogger_id: tag:blogger.com,1999:blog-25302544.post-1270695247859204922
blogger_orig_url: https://psychattic.blogspot.com/2011/01/generate-anatomical-roi-mask-based-on.html</li>
</ul>
<hr/>
<p>&lt;p&gt;Here, I want to share a c-shell script I wrote last Friday (20110/11/14) . The script creates a mask which mask out all the brain regions except amygdala (amyg.), auditory cortex and Brodmann area 10. The three brain areas are the regions of interest (ROIs) of my study. The ROIs are based on the probabilistic cytoarchitectonic map called CA_N27_MPM (See Eickhoff et. al., 2006 [&lt;a href="http://experiment.iitalia.com/fmri/software/spmatlas/Anatomy/Documentation/Eickhoff05.pdf" target="_blank"&gt;PDF&lt;/a&gt;]). This map comes with a widely used software package for &lt;span class="Apple-style-span"&gt;A&lt;/span&gt;nalysis of &lt;span class="Apple-style-span"&gt;F&lt;/span&gt;unctional &lt;span class="Apple-style-span"&gt;N&lt;/span&gt;euro&lt;span class="Apple-style-span"&gt;I&lt;/span&gt;mage, &lt;a href="http://afni.nimh.nih.gov/afni" target="_blank"&gt;AFNI&lt;/a&gt;. And the commands used in the script are also from &lt;a href="http://afni.nimh.nih.gov/afni" target="_blank"&gt;AFNI&lt;/a&gt;. The script was written to call &lt;a href="http://en.wikipedia.org/wiki/Tcsh"&gt;tcsh&lt;/a&gt;. So, &lt;a href="http://afni.nimh.nih.gov/afni" target="_blank"&gt;AFNI&lt;/a&gt; and tcshell are required. It can also work under other Linux and Unix shells if you do not have tcsh installed. Just change the first line of the script to call the shell you like. You can download the script &lt;a href="http://www.megaupload.com/?d=Y0MNZYR1"&gt;here&lt;/a&gt; or copy the code below to any text editor and save as a ".sh" file. Use &lt;a href="http://en.wikipedia.org/wiki/Chmod"&gt;chmod&lt;/a&gt; to make it executable before you run it.&lt;/p&gt;&lt;br /&gt;&lt;blockquote&gt;&lt;p&gt;#!/bin/tcsh&lt;/p&gt;&lt;p&gt;#-xef&lt;/p&gt;&lt;p&gt;# I learned how to do this from &lt;a href="http://afni.nimh.nih.gov/afni/community/board/re"&gt;http://afni.nimh.nih.gov/afni/community/board/re&lt;/a&gt;&lt;br /&gt;ad.php?f=1&amp;amp;i=34988&amp;amp;t=34988#reply_34988&lt;br /&gt;# Also see: &lt;a href="http://afni.nimh.nih.gov/pub/dist/doc/program_help/whereami.html"&gt;http://afni.nimh.nih.gov/pub/dist/doc/program_help/whereami.html&lt;/a&gt;&lt;br /&gt;# Qingyang Li&lt;br /&gt;# 2011 01 14&lt;br /&gt;#&lt;br /&gt;#&lt;br /&gt;# This script create 3 ROIs, Amygdala, Auditory cortex and Brodmann Area 10 (fro&lt;br /&gt;ntal cortex). The there ROIs were labled as 1, 2, 3 in the resulted mask&lt;br /&gt;# For BPD study, amyg. is the area of interest, Auditory is the control, BA10 mi&lt;br /&gt;ght be related.&lt;br /&gt;# The selection of atlas was following the sugestion by Poldrack, 2007(DOI:10.10&lt;br /&gt;93/scan/nsm006)&lt;br /&gt;#&lt;br /&gt;echo ""&lt;br /&gt;echo "22003_bpd2_stats_warped+tlrc must be availabe in the current directory with&lt;br /&gt;the script, or it won't finish"&lt;br /&gt;echo&lt;br /&gt;echo&lt;/p&gt;&lt;p&gt;echo "#### Step 1: create anatomical based ROI###"&lt;br /&gt;whereami -mask_atlas_region CA_N27_MPM:120 -prefix 1 #amyg. CM&lt;br /&gt;whereami -mask_atlas_region CA_N27_MPM:150 -prefix 2 #amyg. SF&lt;br /&gt;whereami -mask_atlas_region CA_N27_MPM:215 -prefix 3 #amyg. LB&lt;br /&gt;whereami -mask_atlas_region CA_N27_MPM:130 -prefix 4 #TE 1.0 Auditory&lt;br /&gt;whereami -mask_atlas_region CA_N27_MPM:195 -prefix 5 #TE 1.1 Auditory&lt;br /&gt;whereami -mask_atlas_region CA_N27_MPM:230 -prefix 6 #TE 1.2 Auditory&lt;br /&gt;whereami -mask_atlas_region TT_Daemon:90 -prefix 7 #BA 10&lt;/p&gt;&lt;p&gt;echo "### Step 2: combine ROIs into on file"&lt;br /&gt;3dcalc -a 1+tlrc -b 2+tlrc -c 3+tlrc -d 4+tlrc -e 5+tlrc -f 6+tlrc -g 7+tlrc -expr 'step(a+b+c)+2*step(d+e+f)+3*step(g)' -prefix roi_mask_HR&lt;/p&gt;&lt;p&gt;echo "### Step 3: resample the high resolution ROI mask"&lt;br /&gt;3dfractionize -template 22003_bpd2_stats_warped+tlrc -input roi_mask_HR+tlrc -clip 0.5 -preserve -prefix roi_mask_LR # here we need a functional dataset as template (22003_bpd2_stats_warped+tlrc)&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;Some endnotes:&lt;/p&gt;  &lt;p&gt;1 The BA10 is from TT_Daemon, that’s because I can not find BA 10 or prefrontal cortex in the CA_N27_MPM atlas. &lt;/p&gt;&lt;p&gt;2 Region of interest (ROI) analysis of functional MRI data is very common these days. The key step to carry out an ROI analysis is to generate an ROI mask. The mask is then applied to the fMRI data, raw or processed, to out put only the information from the voxels within the ROIs. Data in the voxels outside the ROIs will be masked out of the analysis. This is a great way to reduce the dimensionality of the fMRI data. &lt;/p&gt;&lt;p&gt;Generally speaking, there are two ways to generate ROIs. 1) The ROI is based on the functional activation map. It’s a bottom-up, data-driven approach. 2) The ROI is based on the anatomical structures. This approach need some a prior knowledge of the study. For example, if you are doing an auditory perception experiment and you are interest in brain activity in the auditory cortex, you can then create a mask to mask out unrelated brain regions and leave only auditory cortex’s data (yes, if you’re doing a real scientific experiment, you will also need another region as the control ).&lt;/p&gt;  &lt;p&gt;To create an anatomical ROI, you can a) draw ROIs on your subject's high resolution brain image; b) output ROIs based on existing atlas. Method a) needs training: it’s not easy to eyeball brain structure if you are not trained. I myself is lack of this kind of training. The script I created is method b).&lt;/p&gt;&lt;p&gt;3 if you want to know how many voxels there are in each ROI, you can use 3dmaskavd command.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;blockquote&gt;3dmaskave -mask roi_mask_LR+tlrc -mrange 3 3 roi_mask_LR+tlrc&lt;/blockquote&gt;&lt;p&gt;&lt;/p&gt;  &lt;p&gt;The command above will tells you how many voxels are in the ROI  with a value 3 in it. (change -marange 3 3 to -marange 2 2 if you want the info of the ROI with a value 2 in it)&lt;/p&gt;&lt;p&gt;updated on 20110117: changed the last command, add options for 3dfractionize&lt;br /&gt;updated on 20110118: added end note 3&lt;/p&gt;</p>
