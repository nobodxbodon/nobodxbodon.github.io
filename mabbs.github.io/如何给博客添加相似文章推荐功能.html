<h2><a href="https://github.com/mabbs/mabbs.github.io/blob/master/_posts/2024-10-01-suggest.md">ä»“åº“æºæ–‡</a>ï¼Œ<a href="https://mabbs.github.io/2024/10/01/suggest">ç«™ç‚¹åŸæ–‡</a></h2>
<p>çœ‹æ¥å‘é‡æ•°æ®åº“çš„ä½œç”¨æœ‰å¾ˆå¤šå•Šâ€¦â€¦&lt;!--more--&gt;</p>
<h1>èµ·å› </h1>
<p>å‰å‡ å¤©æˆ‘<a href="/2024/09/27/rag.html">ç”¨Cloudflare Vectorizeç»™åšå®¢çš„èŠå¤©æœºå™¨äººåŠ äº†çŸ¥è¯†åº“çš„åŠŸèƒ½</a>ï¼Œæœ¬æ¥æƒ³ç€ç”¨å‘é‡æ•°æ®åº“åšæ–‡ç« æ¨èæ˜¯ä¸æ˜¯æ¯æ¬¡éƒ½è¦èµ°ç¿»è¯‘+å‘é‡åŒ–çš„æ“ä½œï¼Œä¸è¿‡åæ¥æˆ‘åˆä»”ç»†çœ‹äº†ä¸€ä¸‹Cloudflareçš„å®˜æ–¹æ–‡æ¡£ï¼Œå‘ç°å®ƒæ˜¯<a href="https://developers.cloudflare.com/vectorize/reference/client-api/#get-vectors-by-id">å¯ä»¥æ ¹æ®IDæŸ¥è¯¢å­˜å‚¨çš„å‘é‡</a>çš„ï¼Œæ—¢ç„¶è¿™æ ·çš„è¯ç”¨ç°æœ‰çš„æ•°æ®åº“åšä¸€ä¸ªç›¸ä¼¼æ–‡ç« æ¨èåº”è¯¥éå¸¸ç®€å•ï¼Œäºæ˜¯æˆ‘å°±åšäº†ä¸€ä¸ªè¯•è¯•çœ‹ã€‚</p>
<h1>åˆ¶ä½œè¿‡ç¨‹</h1>
<h2>åç«¯éƒ¨åˆ†</h2>
<p>å…¶å®æµç¨‹å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠå¯¹åº”IDçš„å‘é‡æŸ¥å‡ºæ¥ä¹‹åæ‹¿ç€è¿™ä¸ªå‘é‡å†å»æŸ¥è¯¢å°±å¥½äº†ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„å°±æ˜¯å®ƒæŸ¥å‡ºæ¥çš„ç¬¬ä¸€æ¡è‚¯å®šæ˜¯è‡ªå·±ï¼Œæ‰€ä»¥åªè¦æŠŠç¬¬ä¸€æ¡åˆ æ‰å°±è¡Œï¼Œ <del>ä»£ç ä¹Ÿéå¸¸ç®€å•</del> ï¼ˆåæ¥åˆåŠ äº†ç¼“å­˜ç¨å¾®å˜çš„å¤æ‚äº†ğŸ˜‚ï¼‰ï¼š</p>
<pre><code class="lang-javascript">if (url.pathname.startsWith("/suggest")) {
  let resp = [];
  let update_time = url.searchParams.get('update');
  if (update_time) {
    let result = await env.mayx_index.getByIds([
      query
    ]);
    if (result.length) {
      let cache = await db.prepare("SELECT `id`, `suggest`, `suggest_update` FROM `blog_summary` WHERE `id` = ?1")
        .bind(query).first();
      if (!cache.id) {
        return Response.json(resp, {
          headers: commonHeader
        });
      }
      if (update_time != cache.suggest_update) {
        resp = await env.mayx_index.query(result[0].values, { topK: 6 });
        resp = resp.matches;
        resp.splice(0, 1);
        await db.prepare("UPDATE `blog_summary` SET `suggest_update` = ?1, `suggest` = ?2 WHERE `id` = ?3")
          .bind(update_time, JSON.stringify(resp), query).run();
      } else {
        resp = JSON.parse(cache.suggest);
      }
    }
    resp = resp.map(respObj =&gt; {
      respObj.id = encodeURI(respObj.id);
      return respObj;
    });
  }
  return Response.json(resp, {
    headers: commonHeader
  });
}
</code></pre>
<h2>å‰ç«¯éƒ¨åˆ†</h2>
<p>åç«¯å½“ç„¶å¾ˆç®€å•ï¼Œä½†æ˜¯æˆ‘ä¹‹å‰æœ‰äº›æ¬ è€ƒè™‘äº†ï¼Œæˆ‘å½“æ—¶åš<a href="/2024/07/03/ai-summary.html">AIæ‘˜è¦</a>å’Œ<a href="/2024/09/27/rag.html">çŸ¥è¯†åº“</a>çš„æ—¶å€™ï¼Œéƒ½åªå­˜äº†æ–‡ç« çš„é“¾æ¥ï¼Œæ²¡æœ‰å­˜æ ‡é¢˜ğŸ˜…â€¦â€¦ä½†æ˜¯æ¨èæ–‡ç« çš„è¶…é“¾æ¥æ€»ä¸èƒ½ä¸æ”¾æ ‡é¢˜å§â€¦â€¦é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿä¸€ç§å°±æ˜¯æˆ‘æŠŠæ•°æ®åº“æ¸…ç©ºç„¶åæ‘˜è¦ä¸­åŠ ä¸€ä¸ªå­—æ®µï¼Œå‘é‡æ•°æ®åº“ä¸­åŠ ä¸€ä¸ªå…ƒæ•°æ®ï¼Œè¿™æ ·æŸ¥è¯¢çš„æ—¶å€™å°±èƒ½æŸ¥åˆ°æ ‡é¢˜ç„¶åæ˜¾ç¤ºå‡ºæ¥äº†ã€‚ä¸è¿‡è¿™ç§æ–¹æ³•æˆ‘ä»”ç»†è€ƒè™‘äº†ä¸€ä¸‹ï¼Œéº»çƒ¦æ˜¯ä¸€æ–¹é¢ï¼Œå¦ä¸€æ–¹é¢æ˜¯æˆ‘çš„æ¥å£æ²¡åšéªŒè¯ï¼Œæœ‰äººä¹±ä¸Šä¼ æ–‡ç« ä¼šå½±å“æ¨èé“¾æ¥æ˜¾ç¤ºçš„å†…å®¹ï¼Œä¸å¤ªåˆé€‚â€¦â€¦é‚£åº”è¯¥ç”¨ä»€ä¹ˆåŠæ³•å‘¢ï¼Ÿ<br/>
  æˆ‘è¿˜æƒ³åˆ°ä¸€ä¸ªåŠæ³•ï¼Œæˆ‘ä¹‹å‰<a href="/2021/07/23/search.html">ç»™åšå®¢åšè¿‡å…¨æ–‡æœç´¢çš„åŠŸèƒ½</a>ï¼Œç”¨è¿™ä¸ªJSå…³è”æŸ¥è¯¢å°±èƒ½æŸ¥åˆ°æ ‡é¢˜ï¼Œè€Œä¸”æŸ¥ä¸åˆ°çš„å†…å®¹ä¹Ÿæ˜¾ç¤ºä¸å‡ºæ¥ï¼Œè¿™æ ·å°±èƒ½é¿å…æœ‰äººæ•…æ„ä¹±ä¸Šä¼ å¯¼è‡´æ˜¾ç¤ºå¥‡æ€ªçš„å†…å®¹äº†ï¼Œä¸è¿‡ä¹‹å‰çš„è®¾è®¡æ˜¯æ¯æ¬¡æŸ¥è¯¢éƒ½è¦åŠ è½½ä¸€æ¬¡åŒ…å«æˆ‘æ–‡ç« å†…å®¹çš„JSONæ–‡ä»¶ï¼Œæ„Ÿè§‰ä¸å¤ªåˆç†ï¼Œè™½ç„¶é‚£ä¸ªæ–‡ä»¶ä¸ç®—ç‰¹åˆ«å¤§ï¼Œä½†æ˜¯ä¹ŸæŒºå½±å“é€Ÿåº¦çš„ï¼Œæ‰€ä»¥æˆ‘æƒ³äº†ä¸€ä¸‹è¿˜æ˜¯ç”¨localStorageç¼“å­˜ä¸€ä¸‹æ¯”è¾ƒå¥½ï¼Œæ‰€ä»¥å¢åŠ äº†ä¸€ä¸ªèƒ½ç¼“å­˜è·å–æœç´¢JSONçš„å‡½æ•°ï¼š</p>
<pre><code class="lang-javascript">function getSearchJSON(callback) {
  var searchData = JSON.parse(localStorage.getItem("blog_" + lastUpdated.valueOf()));
  if (!searchData) {
    localStorage.clear();
    $.getJSON("/search.json", function (data) {
        localStorage.setItem("blog_" + lastUpdated.valueOf(), JSON.stringify(data));
        callback(data);
    });
  } else {
    callback(searchData);
  }
}
</code></pre>
<p>åšå¥½è¿™ä¸ªä¹‹åå°±å¯ä»¥åšæ–‡ç« æ¨èçš„åŠŸèƒ½äº†ï¼Œä¸è¿‡æ–‡ç« æ¨èåº”ä¸åº”è¯¥åŠ è½½å®Œé¡µé¢å°±åŠ è½½å‘¢ï¼Ÿå…¶å®æˆ‘æµ‹äº†ä¸€ä¸‹Vectorizeæ•°æ®åº“çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œä¸ç®—å¾ˆæ…¢ï¼Œä½†è¿˜æ˜¯éœ€è¦æ—¶é—´ï¼Œå¦å¤–å…è´¹ç‰ˆæˆ‘çœ‹äº†ä¸‹é¢åº¦æ˜¯æ¯æœˆ3000ä¸‡ä¸ªæŸ¥è¯¢çš„å‘é‡ç»´åº¦ï¼Œè¿™ä¸ªå…¶å®æˆ‘æ²¡çœ‹å¤ªæ‡‚ğŸ˜‚ã€‚å¦å¤–Cloudflareä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰å±•ç¤ºå…è´¹ç‰ˆå‰©ä½™çš„é¢åº¦ï¼Œè€Œä¸”å®ƒæ˜¯æŒ‰æœˆè®¡ç®—çš„ï¼Œå¯¼è‡´æˆ‘ä¸æ•¢ä¹±ç”¨è¿™ä¸ªæŸ¥è¯¢ã€‚ <del>æ‰€ä»¥æˆ‘æƒ³äº†ä¸€ä¸‹è¿˜æ˜¯ç»™ä¸ªæŒ‰é’®æ¥è°ƒç”¨å§</del> ï¼ˆåæ¥æƒ³äº†ä¸€ä¸‹å¹²è„†ç›´æ¥è°ƒç”¨ç„¶ååŠ ä¸ªç¼“å­˜å§ï¼Œæ¯•ç«Ÿæˆ‘çš„æ–‡ç« ä¸å˜ï¼Œæ¨èå†…å®¹ä¹Ÿä¸ä¼šå˜ï¼‰ã€‚æœ€ç»ˆè°ƒç”¨çš„å‡½æ•°å¦‚ä¸‹ï¼š</p>
<pre><code class="lang-javascript">function getSuggestBlog(blogurl) {
    var suggest = $("#suggest-container")[0];
    suggest.innerHTML = "Loading...";
    $.get(BlogAPI + "/suggest?id=" + blogurl + "&amp;update=" + lastUpdated.valueOf(), function (data) {
        if (data.length) {
            getSearchJSON(function (search) {
                suggest.innerHTML = '&lt;b&gt;æ¨èæ–‡ç« &lt;/b&gt;&lt;hr style="margin: 0 0 5px"/&gt;';
                const searchMap = new Map(search.map(item =&gt; [item.url, item]));
                const merged = data.map(suggestObj =&gt; {
                    const searchObj = searchMap.get(suggestObj.id);
                    return searchObj ? { ...searchObj } : null;
                });
                merged.forEach(element =&gt; {
                    if (element) {
                        suggest.innerHTML += "&lt;a href=" + element.url + "&gt;" + element.title + "&lt;/a&gt; - " + element.date + "&lt;br /&gt;";
                    }
                });
            });
        } else {
            suggest.innerHTML = "æš‚æ— æ¨èæ–‡ç« â€¦â€¦";
        }
    });
}
</code></pre>
<h1>æ„Ÿæƒ³</h1>
<p>çœ‹æ¥å‘é‡æ•°æ®åº“çš„ç”¨é€”è¿˜æ˜¯æŒºå¹¿æ³›çš„ï¼Œä¸ä»…ä»…æ˜¯ä¸ºäº†ç»™AIä½¿ç”¨ï¼Œè¯´ä¸å®šè¿˜èƒ½åšæ›´å¤šæœ‰æ„æ€çš„åŠŸèƒ½ï¼Œè¿™ä¸‹ä¸å¾—ä¸æ›´ä¾èµ–Cloudflareäº†ğŸ˜†ã€‚<br/>
  å¦å¤–éšç€åšäº†è¶Šæ¥è¶Šå¤šçš„åŠŸèƒ½ï¼Œåšæ–°çš„åŠŸèƒ½è¿˜èƒ½ç”¨ä¸Šæ—§çš„åŠŸèƒ½ï¼Œæ„Ÿè§‰è¿™æ ·æˆ‘çš„åšå®¢å¯ä»¥æœ‰ä¸å°‘å‘å±•çš„ç©ºé—´å•ŠğŸ˜ã€‚</p>
