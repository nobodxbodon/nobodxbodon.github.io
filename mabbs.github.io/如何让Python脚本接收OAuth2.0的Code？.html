<h2><a href="https://github.com/mabbs/mabbs.github.io/blob/master/_posts/2023-08-01-auth.md">ä»“åº“æºæ–‡</a>ï¼Œ<a href="https://mabbs.github.io/2023/08/01/auth">ç«™ç‚¹åŸæ–‡</a></h2>
<hr/>
<p>layout: post
title: å¦‚ä½•è®©Pythonè„šæœ¬æ¥æ”¶OAuth2.0çš„Codeï¼Ÿ</p>
<h2>tags: [Python, æœåŠ¡å™¨, OAuth]</h2>
<p>è¶Šç®€å•ï¼Œå°±è¶Šå¤æ‚ã€‚&lt;!--more--&gt;</p>
<h1>èµ·å› </h1>
<p>æœ€è¿‘æˆ‘åœ¨å†™ä¸€ä¸ªåœ¨Windowsä¸Šè¿è¡Œçš„Pythonè„šæœ¬ï¼Œéœ€è¦åšä¸€ä¸ªç±»ä¼¼äºç¬¬ä¸‰æ–¹ç™»å½•çš„åŠŸèƒ½ã€‚ä¸€èˆ¬æ¥è¯´åƒè¿™ç§ä¸œè¥¿éƒ½æ˜¯ä½¿ç”¨çš„OAuth2.0æ¥åšè®¤è¯ï¼Œæˆ‘æ¥å…¥çš„å¹³å°æ²¡æœ‰æ‚¬å¿µçš„ä¹Ÿæ˜¯ä½¿ç”¨çš„è¿™ä¸ªä¸œè¥¿ï¼Œå…¶ä¸­çš„é‡ç‚¹å°±æ˜¯è·å–åˆ°ç¬¬ä¸‰æ–¹ç½‘ç«™çš„æˆæƒç Codeï¼Œç„¶åç”¨å®ƒæ¢å–ç”¨æˆ·ä¿¡æ¯ã€‚äºæ˜¯æˆ‘å°±åœ¨æƒ³æ€ä¹ˆåšæ¯”è¾ƒå¥½å‘¢ï¼Ÿ</p>
<h1>è§£å†³æ–¹æ³•</h1>
<h2>1. ä½¿ç”¨URI Scheme</h2>
<p>æˆ‘çœ‹VSCodeåœ¨å®ç°ç±»ä¼¼åŠŸèƒ½çš„æ—¶å€™ä¼¼ä¹ç”¨åˆ°äº†URI Schemeï¼Œå°±æ˜¯åœ¨ç³»ç»Ÿä¸­æ³¨å†Œä¸€ä¸ªä¼ªåè®®ï¼Œç„¶åé€šè¿‡è¿™ä¸ªä¼ªåè®®æ¥è°ƒç”¨ç¨‹åºå®ç°è·å–Codeï¼Œæ–¹æ³•å¾ˆç®€å•ï¼Œé¦–å…ˆå…ˆåœ¨æ³¨å†Œè¡¨é‡Œå¯¼å…¥ï¼š</p>
<pre><code class="lang-ini">Windows Registry Editor Version 5.00  

[HKEY_CLASSES_ROOT\mayx]  
"URL Protocol"="D:\\mayx.exe"  
@="MayxProtocol"  

[HKEY_CLASSES_ROOT\mayx\DefaultIcon]  
@="D:\\mayx.exe,1"  

[HKEY_CLASSES_ROOT\mayx\shell]  

[HKEY_CLASSES_ROOT\mayx\shell\open]  

[HKEY_CLASSES_ROOT\mayx\shell\open\command]  
@="\"D:\\mayx.exe\" \"%1\""
</code></pre>
<p>ç„¶åç¼–å†™ä¸€ä¸ªPythonè„šæœ¬å¹¶ç”¨Pyinstalleræ‰“åŒ…ï¼š</p>
<pre><code class="lang-python">import sys
print(sys.argv[1])
</code></pre>
<p>æœ€åå°†å›è°ƒåœ°å€å¡«ä¸ºâ€œmayx://getâ€ï¼Œè¿™æ ·è®¤è¯å®Œæˆä¹‹åå°±ä¼šåƒè¿™æ ·è°ƒç”¨ç¨‹åºï¼šâ€œD:\mayx.exe mayx://get?code=somethingâ€ï¼Œå†ç”¨urllibç®€å•åšä¸ªè§£æå°±å®Œæˆäº†ã€‚<br/>
  è¿™æ ·çœ‹èµ·æ¥æ˜¯ä¸æ˜¯éå¸¸çš„ç®€å•ï¼Ÿçœ‹èµ·æ¥ç¡®å®æ˜¯æŒºç®€å•çš„ï¼Œå¯æƒœå‘æ¯”è¾ƒå¤§ï¼Œç¬¬ä¸€ä¸ªæ˜¯åƒä¸Šè¿°è¿™æ ·çš„æ³¨å†Œè¡¨æœ‰äº›æ€æ¯’è½¯ä»¶ä¼šæ‹’ç»å¯¼å…¥ï¼Œå› ä¸ºåƒâ€œshell\open\commandâ€è¿™ç§ä¸œè¥¿è¢«ç—…æ¯’å•¥çš„æ»¥ç”¨çš„åœ°æ–¹å¤ªå¤šäº†ï¼Œé™¤éè½¯ä»¶é€šè¿‡äº†æ•°å­—ç­¾åæˆ–è€…æŸäº›è®¤è¯ï¼Œå¦åˆ™æ­£å¸¸æƒ…å†µä¸‹æ ¹æœ¬æ²¡æ³•å¯¼å…¥ã€‚äºŒæ˜¯ä¸æ˜¯æ‰€æœ‰çš„ç¬¬ä¸‰æ–¹å¹³å°éƒ½æ”¯æŒä¼ªåè®®çš„æ–¹å¼è°ƒç”¨ï¼Œä¸è¿‡æˆ‘è¯•äº†ä¸€ä¸‹æˆ‘ç”¨çš„é‚£ä¸ªå¹³å°å€’æ˜¯æ”¯æŒğŸ˜‚ï¼Œé™¤äº†æ€æ¯’è½¯ä»¶æ¯”è¾ƒè®¨åŒä¹‹å¤–å…¶ä»–çš„å€’è¿˜å¥½ã€‚</p>
<h2>2. ä½¿ç”¨httpæœåŠ¡ç›‘å¬</h2>
<p>å¾ˆå¤šè·¨å¹³å°çš„ç¨‹åºï¼Œåƒæœ‰äº›ä¸»è¦åœ¨Linuxä¸Šè¿è¡Œçš„æŸäº›ç¨‹åºå°±å–œæ¬¢åœ¨è·å–Codeçš„æ—¶å€™å¯åŠ¨ä¸€ä¸ªç®€å•çš„webæœåŠ¡ã€‚å…¶å®ç”¨è¿™ä¸ªæ–¹æ³•çš„è¯å¯èƒ½è¿˜æ›´æ–¹ä¾¿ä¸€ç‚¹ï¼Œä¸å®¹æ˜“å‡ºé—®é¢˜ã€‚</p>
<h3>ä½¿ç”¨Flaskå®ç°</h3>
<p>æœ€å¼€å§‹ï¼Œæˆ‘æƒ³ç€è¦ä¸ç„¶å°±ç”¨Flaskæ¥å®ç°è¿™ä¸ªåŠŸèƒ½å§ï¼Œå®ç°èµ·æ¥ä¹Ÿç®€å•ï¼Œå†™èµ·æ¥å°±å‡ è¡Œï¼š</p>
<pre><code class="lang-python">from flask import Flask, request
code = ""
app = Flask(__name__)
@app.route('/getcode')
def get():
    global code
    code = request.args.get("code")
    shutdown = request.environ["werkzeug.server.shutdown"]
    shutdown()
    return "OK"

app.run(host="127.0.0.1",port=8000)
print(code)
</code></pre>
<p>çœ‹èµ·æ¥ä¹Ÿç¡®å®å¾ˆç®€å•ï¼ŒåŠŸèƒ½å®ç°çš„ä¹Ÿå¾ˆå®Œç¾ï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜æ˜¯æ€»æ„Ÿè§‰ç”¨Flaskåšè¿™ä¹ˆç®€å•çš„äº‹æƒ…å®åœ¨æ˜¯å¤§æå°ç”¨ï¼Œæ‰“åŒ…æˆç¨‹åºä¹Ÿè¦å ä¸å°‘ç©ºé—´ï¼Œå¦å¤–å°±æ˜¯è¿™ä¸ªæ–¹æ³•å·²ç»è¢«å¼ƒç”¨äº†ï¼Œæ„Ÿè§‰å°±æ˜¯å¾ˆä¸çˆ½ã€‚é‚£è¦è¯´ä¸çˆ½çš„è¯æ€ä¹ˆæ‰çˆ½å‘¢ï¼Ÿ</p>
<h3>ä½¿ç”¨socketå®ç°</h3>
<p>æˆ‘æƒ³èµ·æ¥ä¹‹å‰æœŸæœ«æ—¶å†™çš„æœŸæœ«ä½œä¸š<a href="https://github.com/Mabbs/socket-bbs">socket-bbs</a>ï¼Œè¿™å°±æ˜¯ç”¨socketå®ç°çš„ä¸€ä¸ªç®€å•çš„è®ºå›ï¼Œé‚£æˆ‘è¿™ä¹ˆç®€å•çš„åŠŸèƒ½æƒ³æ¥ç”¨socketå®ç°ä¸æ˜¯å¾ˆå¥½å—ï¼Ÿäºæ˜¯å°±å†™äº†ä¸€ä¸ªï¼šï¼ˆè¿™æ®µä»£ç æ²¡æœ‰æµ‹è¯•ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ä¸èƒ½ç”¨æ‰€ä»¥æŠŠä»£ç åˆ äº†ï¼Œè¿™æ˜¯é‡æ–°åšçš„ï¼‰</p>
<pre><code class="lang-python">import socket
import urllib.parse
server = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #æ‰“å¼€ä¸€ä¸ªç½‘ç»œè¿æ¥
server.bind(('127.0.0.1',8000)) #ç»‘å®šè¦ç›‘å¬çš„ç«¯å£
server.listen(5)  # è®¾ç½®æœ€å¤§çš„è¿æ¥æ•°é‡ä¸º5
code = ""
while True:
    sock, addr = server.accept()  # å»ºç«‹å®¢æˆ·ç«¯è¿æ¥
    data = sock.recv(8192).decode('utf-8').split('\r\n')#æ¥æ”¶TCPæ•°æ®ï¼Œæ•°æ®ä»¥å­—ç¬¦ä¸²çš„å½¢å¼è¿”è¿˜
    if not data[0]:
        sock.close()  # å…³é—­è¿æ¥
        continue
    url = urllib.parse.urlparse(data[0].split()[1])
    if url.path == '/getcode':
        query = urllib.parse.parse_qs(self.data)
        code = query["code"][0]
        sock.send(("HTTP/1.0 200 OK" + '\r\n').encode('utf-8'))
        sock.send(("Content-Type: text/html; charset=utf-8" + '\r\n').encode('utf-8'))
        sock.send('\r\n'.encode('utf-8'))
        sock.send("OK".encode('utf-8')) #å‘é€TCPæ•°æ®
        sock.close()  # å…³é—­è¿æ¥
        break
    else:
        sock.send(("HTTP/1.0 404 Not Found" + '\r\n').encode('utf-8'))
        sock.send(("Content-Type: text/html; charset=utf-8" + '\r\n').encode('utf-8'))
        sock.send('\r\n'.encode('utf-8'))
        sock.send("Not Found".encode('utf-8')) #å‘é€TCPæ•°æ®
        sock.close()  # å…³é—­è¿æ¥
print(code)
</code></pre>
<p>çœ‹èµ·æ¥æ˜¯ä¸æ˜¯å¤æ‚å¤šäº†ï¼Ÿå…¶å®å¤§å¤šæ•°æ—¶å€™å·¥ä½œçš„å¥½åƒæŒºæ­£å¸¸çš„ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆè«åå…¶å¦™ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™ä¼šå¡ä½ï¼Œæ”¹äº†åŠå¤©å¤´éƒ½å¤§äº†ï¼Œäºæ˜¯å°±åªå¥½æ”¾å¼ƒè¿™ç§æ–¹æ³•äº†â€¦â€¦</p>
<h3>ä½¿ç”¨http.serverå®ç°</h3>
<p>è¿™æ—¶å€™æˆ‘çªç„¶æƒ³åˆ°æˆ‘å¹³æ—¶ç”¨æ¥ä¼ æ–‡ä»¶ç”¨çš„pythonè‡ªå¸¦çš„æ¨¡å—http.serverï¼Œæ—¢ç„¶è¿™ä¸ªæ¨¡å—æ˜¯è‡ªå¸¦çš„ï¼Œå¤§å°åº”è¯¥å¤§ä¸åˆ°å“ªå»å§ï¼Ÿéšåæˆ‘å°±å†™äº†ä¸€ä¸ªï¼š</p>
<pre><code class="lang-python">from http.server import BaseHTTPRequestHandler, ThreadingHTTPServer
import urllib.parse
code = ""
class Resquest(BaseHTTPRequestHandler):
    timeout = 5
    def do_GET(self):
        url = urllib.parse.urlparse(self.path)
        if url.path == "/getuser":
            self.send_response(200)
            self.send_header("Content-type", "text/html")  # è®¾ç½®æœåŠ¡å™¨å“åº”å¤´
            code = urllib.parse.parse_qs(url.query)["code"][0]
            buf = '''OK'''
            self.wfile.write(buf.encode())
            self.server.shutdown()
        else:
            self.send_response(404)
            self.send_header("Content-type", "text/html")  # è®¾ç½®æœåŠ¡å™¨å“åº”å¤´
            self.end_headers()
            buf = '''Not Found'''
            self.wfile.write(buf.encode())
host = ("127.0.0.1", 8000)
server = ThreadingHTTPServer(host, Resquest)
print("Starting server, listen at: %s:%s" % host)
server.serve_forever()
server.socket.close()
print(code)
</code></pre>
<p>æœ€åæ‰“åŒ…è¯•äº†ä¸€ä¸‹ï¼ŒåŠŸèƒ½æ­£å¸¸ï¼Œè™½ç„¶è¿˜æ˜¯å¤§äº†ç‚¹ï¼Œä¸è¿‡æ¯”Flaskå°ğŸ˜ã€‚å…¶å®æˆ‘åœ¨å†™è¿™ä¸ªä»£ç çš„æ—¶å€™ï¼Œæœ€å¼€å§‹ä¸çŸ¥é“è¦åœ¨æœ€ååŠ ä¸Š<code>server.socket.close()</code>ï¼Œä¸€å¼€å§‹å†™çš„æ—¶å€™æ€»æ˜¯é‡åˆ°ç¨‹åºæ‰§è¡Œå®Œä¹‹å‰ç«¯å£å¿…å®šä¸ä¼šé‡Šæ”¾ï¼Œä»¤äººå¾ˆçƒ¦ï¼Œç›´æ¥æœä¹Ÿæ²¡ä»€ä¹ˆå¥½çš„ç»“æœï¼Œä¸è¿‡é—®äº†ä¸‹ChatGPTç«‹é©¬å°±è§£å†³äº†ğŸ¤£ï¼Œå®ƒè¯´ï¼š</p>
<blockquote><p>å½“ä½ è°ƒç”¨<code>server.shutdown()</code>æ¥åœæ­¢æœåŠ¡å™¨æ—¶ï¼Œå®ƒä¼šåœæ­¢æ¥æ”¶æ–°çš„è¿æ¥ï¼Œå¹¶å…³é—­å·²æœ‰çš„è¿æ¥ã€‚ä½†æ˜¯ï¼Œç”±äºPythonçš„socketåº“çš„è®¾è®¡ï¼Œsocketå¯¹è±¡å¹¶ä¸ä¼šç«‹å³é‡Šæ”¾ç«¯å£ã€‚ç›¸åï¼Œå®ƒä¼šåœ¨ä¸€æ®µæ—¶é—´å†…å¤„äºTIME_WAITçŠ¶æ€ï¼Œä»¥ç¡®ä¿åœ¨ç½‘ç»œä¸­æ‰€æœ‰æŒ‚èµ·çš„æ•°æ®éƒ½è¢«æ­£ç¡®ä¼ é€’æˆ–ä¸¢å¼ƒã€‚è¿™æ˜¯ä¸€ç§ç½‘ç»œåè®®çš„è¦æ±‚ï¼Œç§°ä¸º"TCP TIME_WAIT"çŠ¶æ€ã€‚</p>
</blockquote>
<p>AIè¿˜çœŸæ˜¯æ–¹ä¾¿å•Šâ€¦â€¦</p>
<h1>æ„Ÿæƒ³</h1>
<p>è§£å†³è¿™ä¹ˆä¸€ä¸ªå°é—®é¢˜å´ä¸€æ—¶åŠä¼šæ‹¿ä¸ä¸‹æœ€åˆé€‚çš„æ–¹æ¡ˆï¼Œè¿™éš¾é“å°±æ˜¯äº†è§£å¤ªå¤šçš„å‰¯ä½œç”¨å—ğŸ˜ï¼Œä¸è¿‡æœ€ç»ˆæ¥çœ‹è¿˜æ˜¯AIå‰å®³ï¼Œä¸€ä¸‹å­å°±è§£å†³äº†æˆ‘çš„é—®é¢˜ã€‚</p>
